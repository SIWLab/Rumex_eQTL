---
title: "MAF for eqtls"
author: "Meng"
date: "2024-06-20"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(patchwork)
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"
```

# eqtls that affect multiple genes in the same tissue
FL: 32397 sig, 31274 unique SNPs, 2089 eqtls affect multiple genes
ML: 23769 sig, 22643 unique SNPs, 2092 eqtls affect multiple genes
MP: 12224 sig, 11807 unique SNPs, 752 eqtls affect multiple genes
```{r}
length(unique(FL_eqtl_sig$variant_id)) # 31274
FL_eqtl_multigene <- FL_eqtl_sig %>% 
     group_by(variant_id) %>%
     filter(n()>1) # 2089

length(unique(ML_eqtl_sig$variant_id)) # 22643
ML_eqtl_multigene <- ML_eqtl_sig %>% 
     group_by(variant_id) %>%
     filter(n()>1) # 2092

length(unique(MP_eqtl_sig$variant_id)) # 11807
MP_eqtl_multigene <- MP_eqtl_sig %>% 
     group_by(variant_id) %>%
     filter(n()>1) # 752

p1 <- ggplot(ML_eqtl_multigene, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male leaf")
p2 <- ggplot(FL_eqtl_multigene, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Female leaf")
p3 <- ggplot(MP_eqtl_multigene, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male pollen")

p1 + p2 + p3
```
```{r}
wilcox.test(ML_eqtl_multigene$maf, MP_eqtl_multigene$maf)
```


# MAF for significant cis-eQTL in each tissue

## keep unique SNPs for MAF
```{r}
ML_eqtl_sig_af <- ML_eqtl_sig %>% select(variant_id, af, maf) %>% distinct()
FL_eqtl_sig_af <- FL_eqtl_sig %>% select(variant_id, af, maf) %>% distinct()
MP_eqtl_sig_af <- MP_eqtl_sig %>% select(variant_id, af, maf) %>% distinct()
```

```{r}
p1 <- ggplot(ML_eqtl_sig_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male leaf")
p2 <- ggplot(FL_eqtl_sig_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Female leaf")
p3 <- ggplot(MP_eqtl_sig_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male pollen")

p1 + p2 + p3
```


## keep the most significant SNP per gene
```{r}
ML_eqtl_sig_min <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  filter(pval_nominal == min(pval_nominal)) # 3131

FL_eqtl_sig_min <- FL_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  filter(pval_nominal == min(pval_nominal)) # 3393

MP_eqtl_sig_min <- MP_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  filter(pval_nominal == min(pval_nominal)) # 1790

ML_eqtl_sig_min_af <- ML_eqtl_sig_min %>% select(variant_id, af, maf) %>% distinct()
FL_eqtl_sig_min_af <- FL_eqtl_sig_min %>% select(variant_id, af, maf) %>% distinct()
MP_eqtl_sig_min_af <- MP_eqtl_sig_min %>% select(variant_id, af, maf) %>% distinct()
```

```{r}
p1 <- ggplot(ML_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male leaf")+ xlab("MAF")+ theme(text = element_text(size = 10))
p2 <- ggplot(FL_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Female leaf")+ xlab("MAF")+ theme(text = element_text(size = 10))
p3 <- ggplot(MP_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male pollen")+ xlab("MAF")+ theme(text = element_text(size = 10))

p1 + p2 + p3
```


## keep a random SNP per gene
fewer than egenes?
```{r}
length(unique(MP_eqtl_sig$phenotype_id)) # 1783
length(unique(ML_eqtl_sig$phenotype_id)) # 3118
length(unique(FL_eqtl_sig$phenotype_id)) # 3380

set.seed(123)
MP_eqtl_sig_random <- MP_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1)

ML_eqtl_sig_random <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1)

FL_eqtl_sig_random <- FL_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1)

ML_eqtl_sig_random_af <- ML_eqtl_sig_random %>% select(variant_id, af, maf) %>% distinct()
FL_eqtl_sig_random_af <- FL_eqtl_sig_random %>% select(variant_id, af, maf) %>% distinct()
MP_eqtl_sig_random_af <- MP_eqtl_sig_random %>% select(variant_id, af, maf) %>% distinct()
```

```{r}
p<-ggplot(ML_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male leaf")+ xlab("MAF")+ theme(text = element_text(size = 10))

p_data <- ggplot_build(p)$data[[1]]
sum(p_data$y)
p_data$y_prop <- p_data$y/3118
ggplot(p_data, aes(x=x, y=y_prop)) +
  geom_bar(stat="identity",colour="black", fill="white")
```

```{r}
p4 <- ggplot(ML_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(aes(y=..density..), colour="black", fill="white",binwidth=0.01) + theme_classic() + ggtitle("Male leaf")+ xlab("MAF")+ theme(text = element_text(size = 10))+geom_density(alpha=.2) 
p5 <- ggplot(FL_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(aes(y=..density..), colour="black", fill="white",binwidth=0.01) + theme_classic() + ggtitle("Female leaf")+ xlab("MAF")+ theme(text = element_text(size = 10))+geom_density(alpha=.2) 
p6 <- ggplot(MP_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(aes(y=..density..), colour="black", fill="white",binwidth=0.01) + theme_classic() + ggtitle("Male pollen")+ xlab("MAF")+ theme(text = element_text(size = 10))+geom_density(alpha=.2) 

p4 + p5 + p6
```
```{r}
p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(nrow = 2)
```



## Mann-Whitney U test of MAF of each tissue
```{r}
median(ML_eqtl_sig_random_af$maf)
IQR(ML_eqtl_sig_random_af$maf)
median(MP_eqtl_sig_random_af$maf)
IQR(MP_eqtl_sig_random_af$maf)

wilcox.test(ML_eqtl_sig_random_af$maf, MP_eqtl_sig_random_af$maf)
```
0.1044776
0.1083333

0.1048661
0.1135989
W = 2676074, p-value = 0.02967

# venn diagram
```{r}
v1<-ML_eqtl_sig$variant_id
v2<-FL_eqtl_sig$variant_id
v3<-MP_eqtl_sig$variant_id

write.table(v1, file = paste0(data, "ml.txt"), row.names = F, quote = F, col.names = F)
write.table(v2, file = paste0(data, "fl.txt"), row.names = F, quote = F, col.names = F)
write.table(v3, file = paste0(data, "mp.txt"), row.names = F, quote = F, col.names = F)

v1 <- unique(v1) # 22643

venn.diagram(
  x = list(v1, v2, v3),
  category.names = c("male leaf" , "female leaf" , "pollen"),
  filename = 'venn_diagramm_eQTL.png',
  output=TRUE,
  # Set names
  cat.cex = 1,
  cat.fontface = "bold")

```


# plot effect size

```{r}
FL_eqtl_full <- FL_eqtl_full %>% mutate(category = ifelse(pval_nominal < pval_nominal_threshold, "Significant", "Not_Significant"))
ML_eqtl_full <- ML_eqtl_full %>% mutate(category = ifelse(pval_nominal < pval_nominal_threshold, "Significant", "Not_Significant"))
MP_eqtl_full <- MP_eqtl_full %>% mutate(category = ifelse(pval_nominal < pval_nominal_threshold, "Significant", "Not_Significant"))
```

## male leaf
```{r}
ml <- ML_eqtl_sig_min %>% select(phenotype_id, variant_id, slope)
fl <- FL_eqtl_full %>% select(phenotype_id, variant_id, slope, category)
mp <- MP_eqtl_full %>% select(phenotype_id, variant_id, slope, category)

pair1 <- inner_join(ml, fl, by = c("phenotype_id","variant_id"))
colnames(pair1)[c(3:4)] <- c("male_leaf", "female_leaf") # 621
pair2 <- inner_join(ml, mp, by = c("phenotype_id","variant_id"))
colnames(pair2)[3:4] <- c("male_leaf", "pollen") # 234

cor.test(pair1$female_leaf, pair1$male_leaf, method=c("spearman")) 
cor.test(pair2$male_leaf, pair2$pollen, method=c("spearman")) 
#p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = "right")
```



female leaf
```{r}
ml <- ML_eqtl_full %>% select(phenotype_id, variant_id, slope, category)
fl <- FL_eqtl_sig_min %>% select(phenotype_id, variant_id, slope)
mp <- MP_eqtl_full %>% select(phenotype_id, variant_id, slope, category)

pair1 <- inner_join(fl, ml, by = c("phenotype_id","variant_id"))
colnames(pair1)[3:4] <- c("female_leaf", "male_leaf") # 525
pair3 <- inner_join(fl, mp, by = c("phenotype_id","variant_id"))
colnames(pair3)[3:4] <- c("female_leaf", "pollen") # 89

cor.test(pair1$female_leaf, pair1$male_leaf, method=c("spearman")) 
cor.test(pair3$female_leaf, pair3$pollen, method=c("spearman")) 
```



pollen
```{r}
ml <- ML_eqtl_full %>% select(phenotype_id, variant_id, slope, category)
fl <- FL_eqtl_full %>% select(phenotype_id, variant_id, slope, category)
mp <- MP_eqtl_sig_min %>% select(phenotype_id, variant_id, slope)

pair2 <- inner_join(mp, ml, by = c("phenotype_id","variant_id"))
colnames(pair2)[3:4] <- c("pollen", "male_leaf") # 249
pair3 <- inner_join(mp, fl, by = c("phenotype_id","variant_id"))
colnames(pair3)[3:4] <- c("pollen", "female_leaf") # 144

cor.test(pair2$male_leaf, pair2$pollen, method=c("spearman")) 
cor.test(pair3$female_leaf, pair3$pollen, method=c("spearman")) 
```

```{r}
p1 <- ggplot(pair1, aes(x = male_leaf, y = female_leaf, color = category)) + geom_point(size=0.8) + theme_classic() + labs(x="Male leaf", y="Female leaf") + theme(text = element_text(size = 11),axis.title.x = element_text(face="bold"))+ scale_colour_manual(values = c("grey", "black"))
p2 <- ggplot(pair2, aes(x = male_leaf, y = pollen, color = category)) + geom_point(size=0.8)+ theme_classic() + labs(x="Male leaf", y="Pollen") + theme(text = element_text(size = 11),axis.title.x = element_text(face="bold"))+ scale_colour_manual(values = c("grey", "black"))


p3 <- ggplot(pair1, aes(x = female_leaf, y = male_leaf, color = category)) + geom_point(size=0.8) + theme_classic() + labs(x="Female leaf", y="Male leaf") + theme(text = element_text(size = 11),axis.title.x = element_text(face="bold"))+ scale_colour_manual(values = c("grey", "black"))
p4 <- ggplot(pair3, aes(x = female_leaf, y = pollen, color = category)) + geom_point(size=0.8)+ theme_classic() + labs(x="Female leaf", y="Pollen") + theme(text = element_text(size = 11),axis.title.x = element_text(face="bold"))+ scale_colour_manual(values = c("grey", "black"))
#p3 + p4 + plot_layout(guides = "collect") & theme(legend.position = "right")

p5 <- ggplot(pair2, aes(x = pollen, y = male_leaf, color = category)) + geom_point(size=0.8)+ theme_classic() + labs(x="Pollen", y="Male leaf") + theme(text = element_text(size = 11),axis.title.x = element_text(face="bold"))+ scale_colour_manual(values = c("grey", "black"))

p6 <- ggplot(pair3, aes(x = pollen, y = female_leaf, color = category)) + geom_point(size=0.8)+ theme_classic() + labs(x="Pollen", y="Feale leaf") + theme(text = element_text(size = 11),axis.title.x = element_text(face="bold"))+ scale_colour_manual(values = c("grey", "black"))
```

```{r}
p1 + p3 + p5 + p2 + p4 + p6 + plot_layout(nrow = 2,guides = "collect")& theme(legend.position = "bottom")
```

```{r}
p1 + p3 + p5 + p2 + p4 + p6 + plot_layout(nrow = 2,guides = "collect")& theme(legend.position = "bottom")
```


```{r}
p1 <- ggplot(ML_eqtl_sig_min, aes(x=slope)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male leaf")
p2 <- ggplot(FL_eqtl_sig_min, aes(x=slope)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Female leaf")
p3 <- ggplot(MP_eqtl_sig_min, aes(x=slope)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male pollen")

p1 + p2 + p3
```




