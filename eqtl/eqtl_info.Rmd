---
title: "addtional info"
author: "Meng"
date: "2024-06-20"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(patchwork)
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"
```

need to produce files from eqtl_permutation.Rmd eg ML_eqtl_full
```{r}
ML_eqtl_sig <-read.csv(paste0(data, "ML_eqtl_sig_Nov.csv"))
FL_eqtl_sig <-read.csv(paste0(data, "FL_eqtl_sig_Nov.csv"))
MP_eqtl_sig <-read.csv(paste0(data, "MP_eqtl_sig_Nov.csv"))

set.seed(13)
ML_eqtl_sig_min <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  filter(pval_nominal == min(pval_nominal)) %>% 
  slice_sample(n = 1) # 2421

FL_eqtl_sig_min <- FL_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  filter(pval_nominal == min(pval_nominal)) %>% 
  slice_sample(n = 1) # 3442

MP_eqtl_sig_min <- MP_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  filter(pval_nominal == min(pval_nominal)) %>% 
  slice_sample(n = 1) # 1475

write.csv(ML_eqtl_sig_min, file = paste0(data, "ML_eqtl_sig_min.csv"), row.names = F, quote = F)
write.csv(FL_eqtl_sig_min, file = paste0(data, "FL_eqtl_sig_min.csv"), row.names = F, quote = F)
write.csv(MP_eqtl_sig_min, file = paste0(data, "MP_eqtl_sig_min.csv"), row.names = F, quote = F)

# write the SNP positions
write.table(ML_eqtl_sig_min$variant_id, file = paste0(data, "ML_eqtl_sig_min.txt"), row.names = F, quote = F, col.names = F)
write.table(MP_eqtl_sig_min$variant_id, file = paste0(data, "MP_eqtl_sig_min.txt"), row.names = F, quote = F, col.names = F)
write.table(FL_eqtl_sig_min$variant_id, file = paste0(data, "FL_eqtl_sig_min.txt"), row.names = F, quote = F, col.names = F)
```


# number of significant eqtl per gene
```{r}

ml_table <- ML_eqtl_sig %>% group_by(phenotype_id) %>%
  dplyr::summarise(
    count = length(variant_id),
    mean_tss = mean(abs(start_distance)),
    median_tss = median(abs(start_distance)))

fl_table <- FL_eqtl_sig %>% group_by(phenotype_id) %>%
  dplyr::summarise(
    count = length(variant_id),
    mean_tss = mean(abs(start_distance)),
    median_tss = median(abs(start_distance)))

mp_table <- MP_eqtl_sig %>% group_by(phenotype_id) %>%
  dplyr::summarise(
    count = length(variant_id),
    mean_tss = mean(abs(start_distance)),
    median_tss = median(abs(start_distance)))


ml_table$category <- "Male_leaf"
fl_table$category <- "Female_leaf"
mp_table$category <- "Pollen"

write.table(ml_table, file = paste0(data, "ml_table.txt"), row.names = F, quote = F, col.names = F)
write.table(fl_table, file = paste0(data, "fl_table.txt"), row.names = F, quote = F, col.names = F)
write.table(mp_table, file = paste0(data, "mp_table.txt"), row.names = F, quote = F, col.names = F)
ml_table <- read.table(paste0(data, "ml_table.txt"))
fl_table <- read.table(paste0(data, "fl_table.txt"))
mp_table <- read.table(paste0(data, "mp_table.txt"))


median(ml_table$count)
median(fl_table$count)
median(mp_table$count)

tablec <- rbind(ml_table,fl_table,mp_table)
tablec$count <- round(tablec$count, digits = 0)
colnames(tablec)[2] <- "count"
colnames(tablec)[5] <- "category"


ggplot(tablec, aes(x=category, y=count)) + geom_boxplot() + theme_classic() + ylim(1,10) +theme(text = element_text(size = 12))+labs(x="Category", y="Number of eQTLs per gene")

ggplot(tablec, aes(count)) + geom_histogram(binwidth = 1) + theme_classic()  +theme(text = element_text(size = 12))+labs(x="Category", y="Number of eQTLs per gene") + facet_grid(rows = vars(category))
```
```{r}
ml_table <- ML_eqtl_sig_filt %>% group_by(phenotype_id) %>%
  dplyr::summarise(
    count = length(variant_id))

ggplot(ml_table, aes(count)) + geom_histogram(binwidth = 1) + theme_classic()  +theme(text = element_text(size = 12))+labs(x="Category", y="Number of eQTLs per gene")
```


# distance to TSS and number of cis-eQTLs
âˆ’log(p)on y-axis and distance to TSS on x-axis. And put a harizontal line indicating the corresponing pval_nominal_threshold of the gene.
```{r}
median(ml_table$median_tss) # 7331
median(fl_table$median_tss) # 7587
median(mp_table$median_tss) # 7056.5

mean(ml_table$median_tss) # 8089.743
mean(fl_table$median_tss) # 8251.179
mean(mp_table$median_tss) # 8034.049

```

```{r}
tablec$median_tss <- round(tablec$median_tss, digits = 0)
tablec$mean_tss <- round(tablec$mean_tss, digits = 0)

ggplot(tablec, aes(x=category, y=median_tss)) + geom_boxplot() + theme_classic() + theme(text = element_text(size = 12))+labs(x="Category", y="Distance to TSS")

ggplot(tablec, aes(x=category, y=mean_tss)) + geom_boxplot() + theme_classic() 
```

keep one eqtl per gene
```{r}
ml_table <- ML_eqtl_sig %>% select(start_distance)
fl_table <- FL_eqtl_sig %>% select(start_distance)
mp_table <- MP_eqtl_sig %>% select(start_distance)


ml_table <- ML_eqtl_sig_min %>% select(start_distance)
fl_table <- FL_eqtl_sig_min %>% select(start_distance)
mp_table <- MP_eqtl_sig_min %>% select(start_distance)

ml_table <- ML_eqtl_sig_random %>% select(start_distance)
fl_table <- FL_eqtl_sig_random %>% select(start_distance)
mp_table <- MP_eqtl_sig_random %>% select(start_distance)

ml_table$category <- "Male_leaf"
fl_table$category <- "Female_leaf"
mp_table$category <- "Pollen"

tablec <- rbind(ml_table,fl_table,mp_table)

nrow(tablec[tablec$start_distance > 0,]) # 4356 random, 4390 min, 30402 all
nrow(tablec[tablec$start_distance < 0,]) # 4375, 4340, 31916

tabelc1 <- tablec[tablec$start_distance > 0,]
median(tabelc1$start_distance) # 6700

tabelc2 <- tablec[tablec$start_distance < 0,]
median(tabelc2$start_distance) # -6762


ggplot(tablec, aes(x=category, y=start_distance)) + geom_violin()+ geom_boxplot(width=0.1) + theme_classic() + theme(text = element_text(size = 12))+labs(x="Category", y="Distance to TSS")

```



```{r}
gene1 <- ML_eqtl_full %>% filter(phenotype_id == "TX_paternal_00029650")
gene2 <- FL_eqtl_full %>% filter(phenotype_id == "TX_paternal_00030127")
gene3 <- MP_eqtl_full %>% filter(phenotype_id == "TX_paternal_00006330")


p1 <- ggplot(gene1, aes(x=start_distance, y=-log(pval_nominal))) + geom_point(alpha = 0.6) + theme_classic() + geom_hline(yintercept=-log(0.0011044), color = "red") + labs(title = "a")+ theme(text = element_text(size = 10))
p2 <- ggplot(gene2, aes(x=start_distance, y=-log(pval_nominal))) + geom_point(alpha = 0.6) + theme_classic() + geom_hline(yintercept=-log(0.00101239), color = "red") + labs(title = "b")+ theme(text = element_text(size = 10))
p3 <- ggplot(gene3, aes(x=start_distance, y=-log(pval_nominal))) + geom_point(alpha = 0.6) + theme_classic() + geom_hline(yintercept=-log(0.000283815), color = "red") + labs(title = "c")+ theme(text = element_text(size = 10))

p1 + p2 + p3 
```





# eqtls that affect multiple genes in the same tissue
```{r}
length(unique(FL_eqtl_sig$variant_id)) 
FL_eqtl_multigene <- FL_eqtl_sig %>% 
     group_by(variant_id) %>%
     filter(n()>1) # 1907

length(unique(ML_eqtl_sig$variant_id)) 
ML_eqtl_multigene <- ML_eqtl_sig %>% 
     group_by(variant_id) %>%
     filter(n()>1) # 1036

length(unique(MP_eqtl_sig$variant_id)) 
MP_eqtl_multigene <- MP_eqtl_sig %>% 
     group_by(variant_id) %>%
     filter(n()>1) # 406

write.csv(ML_eqtl_multigene, file = paste0(data, "ML_eqtl_multigene.csv"), row.names = F, quote = F)
write.csv(FL_eqtl_multigene, file = paste0(data, "FL_eqtl_multigene.csv"), row.names = F, quote = F)
write.csv(MP_eqtl_multigene, file = paste0(data, "MP_eqtl_multigene.csv"), row.names = F, quote = F)

p1 <- ggplot(ML_eqtl_multigene, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male leaf")
p2 <- ggplot(FL_eqtl_multigene, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Female leaf")
p3 <- ggplot(MP_eqtl_multigene, aes(x=maf)) + geom_histogram(binwidth=0.01) + theme_classic() + ggtitle("Male pollen")

p1 + p2 + p3
```


```{r}
wilcox.test(ML_eqtl_multigene$maf, MP_eqtl_multigene$maf)
```


## start distance and effect size
```{r}
ggplot(ml1, aes(x=abs(start_distance), y = abs(slope))) + geom_point()
cor.test(abs(ml1$start_distance), abs(ml1$slope))
```

