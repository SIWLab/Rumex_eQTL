---
title: "conditionally independent eQTLs"
author: "Meng"
date: "2024-11-08"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(patchwork)
library(tidyr)
library(car)
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"
ML_eqtl_sig <- read.csv(paste0(data, "ML_eqtl_sig_Nov.csv"))
FL_eqtl_sig <- read.csv(paste0(data, "FL_eqtl_sig_Nov.csv"))
MP_eqtl_sig <- read.csv(paste0(data, "MP_eqtl_sig_Nov.csv"))
```


# ML
2792 eqtls for 2425 genes (eGenes)
```{r}
ml <- read.table(paste0(data, "ML.cis_independent_qtl.txt"), header = T) # 2792
length(unique(ml$phenotype_id)) # 2425

egene <- as.data.frame(unique(ML_eqtl_sig$phenotype_id)) 
colnames(egene) <- "phenotype_id"
ml <- inner_join(ml, egene, by = "phenotype_id") # 2788
length(unique(ml$phenotype_id)) # 2421

ml1 <- ml %>% filter(rank == 1) # 2403


# fine eGenes with multiple ranked eQTLs
# filter for primary eQTLs
ml1 <- ml %>%
  group_by(phenotype_id) %>% 
  filter(rank == min(rank))
# manually update the top rank for each eGene to rank = 1
ml1$rank <- 1 # 2421
# filter for secondary eQTLs
ml2 <- anti_join(ml, ml1, by = c("phenotype_id", "variant_id")) # 367

# most significant eQTL in each eGene
test1 <- inner_join(ML_egene, ml1, by = c("phenotype_id", "variant_id")) %>% select(phenotype_id, variant_id, rank) # 2339
# rank = 1 but not the most significant eQTL
test2 <- anti_join(ml1, ML_egene, by = c("phenotype_id", "variant_id")) # 82

# write output
write.csv(ml1, file = paste0(data, "ml1.csv"), row.names = F, quote = F)
write.csv(ml2, file = paste0(data, "ml2.csv"), row.names = F, quote = F)
```


## compare primary and secondary eQTLs
```{r}
mean(abs(ml1$slope)) # 1.314509
mean(abs(ml2$slope)) # 1.151421

ml1$category <- "primary"
ml2$category <- "secondary"
ml <- rbind(ml1, ml2)
leveneTest(data = ml, abs(slope) ~ category)
t.test(data = ml, abs(slope) ~ category, var.equal = T)

mean(abs(ml1$start_distance)) # 7922.758
mean(abs(ml2$start_distance)) # 8697.025
leveneTest(data = ml, abs(start_distance) ~ category)
t.test(data = ml, abs(start_distance) ~ category, var.equal = T)
```

Two Sample t-test

data:  abs(slope) by category
t = 6.7868, df = 2786, p-value = 1.395e-11
alternative hypothesis: true difference in means between group primary and group secondary is not equal to 0
95 percent confidence interval:
 0.1159692 0.2102069
sample estimates:
  mean in group primary mean in group secondary 
               1.314509                1.151421 

Two Sample t-test

data:  abs(start_distance) by category
t = -2.3367, df = 2786, p-value = 0.01952
alternative hypothesis: true difference in means between group primary and group secondary is not equal to 0
95 percent confidence interval:
 -1423.9821  -124.5511
sample estimates:
  mean in group primary mean in group secondary 
               7922.758                8697.025 


# FL
```{r}
fl <- read.table(paste0(data, "FL.cis_independent_qtl.txt"), header = T) # 4167
length(unique(fl$phenotype_id)) # 3445
egene <- as.data.frame(unique(FL_eqtl_sig$phenotype_id)) 
colnames(egene) <- "phenotype_id"
fl <- inner_join(fl, egene, by = "phenotype_id") # 4164
length(unique(fl$phenotype_id)) # 3442

fl1 <- fl %>% filter(rank == 1) # 3407
overlap <- inner_join(FL_egene, fl, by = c("phenotype_id", "variant_id")) # 3333
```
[1] "TX_paternal_00008722" "TX_paternal_00009331"
[3] "TX_paternal_00033562"




# MP
```{r}
mp <- read.table(paste0(data, "MP.cis_independent_qtl.txt"), header = T) # 4167
length(unique(mp$phenotype_id)) # 3445
egene <- as.data.frame(unique(MP_eqtl_sig$phenotype_id)) 
colnames(egene) <- "phenotype_id"
mp <- inner_join(mp, egene, by = "phenotype_id") # 4164
length(unique(mp$phenotype_id)) # 3442

mp1 <- mp %>% filter(rank == 1) # 3407
overlap <- inner_join(MP_egene, mp, by = c("phenotype_id", "variant_id"))

```

