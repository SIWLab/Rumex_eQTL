---
title: "MAF null"
author: "Meng"
date: "2024-11-13"
output: html_document
---

```{r setup, include=FALSE}
library(arrow)
library(dplyr)
library(ggplot2)
library(patchwork)
```



# real
```{r}
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"
ML <- read.table(paste0(data, "ML.cis_qtl.txt"), header = T) # 14777

ML_A1 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.1.parquet"))
ML_A2 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.2.parquet"))
ML_A3 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.3.parquet"))
ML_A4 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.4.parquet"))
ML_eqtl <- rbind(ML_A1, ML_A2, ML_A3, ML_A4) # 1272993
sum(ML$num_var) # 1272993

ML_egene <- ML %>% filter(qval < 0.1) # 2425
max(ML_egene$pval_nominal) # 0.0318507
#ML_eqtl_sig01 <- ML_eqtl %>% filter(pval_nominal < 0.001) # 
ML_eqtl_sig01 <- ML_eqtl %>% filter(pval_nominal < 0.0318507) # 102276
# old way: 17283, or 16674 if require q < 0.1

# try BH correction
# ML$pval_adj <- padjust_bh(ML$pval_nominal, fdr_threshold = 0.1)
# ML_egene2 <- ML %>% filter(pval_adj < 0.05) # 11223
# max(ML_egene2$pval_nominal) # 0.0379699
ML_eqtl_sig <- ML_eqtl_sig01

ML_eqtl_sig <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>%
  mutate(count = n()) %>%  
  ungroup() %>%           
  filter(count <= 10) # 29037, 6543

ML_eqtl_full <- inner_join(ML_eqtl, ML[,c(1,16:19)], by = "phenotype_id") 
ML_eqtl_sig <- ML_eqtl_full %>% filter(pval_nominal < pval_nominal_threshold)


ML_eqtl_sig <- ML_eqtl_sig %>% mutate(maf = ifelse(af <= 0.5, af, 1 - af))
ML_eqtl_sig_min <- ML_eqtl_sig %>%
    group_by(phenotype_id) %>% 
    filter(pval_nominal == min(pval_nominal))  # 2879 -> 10826
ML_eqtl_sig_min <- ML_eqtl_sig_min %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1) # 10778, 8265

ML_eqtl_sig_min_af <- ML_eqtl_sig_min %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_min_af$maf <- round(ML_eqtl_sig_min_af$maf, digits = 3)
    
set.seed(123)
ML_eqtl_sig_random <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1) # 2868, 10778

ML_eqtl_sig_random_af <- ML_eqtl_sig_random %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_random_af$maf <- round(ML_eqtl_sig_random_af$maf, digits = 3)
  

p<-ggplot(ML_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) + scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 

p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
write.table(p_data, file = paste0(data, "ML_eqtl_real_Dec10_genewise.txt"), row.names = F, quote = F, sep = "\t")

p<-ggplot(ML_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) + scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 

p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
write.table(p_data, file = paste0(data, "ML_eqtl_real_random_Dec10_genewise.txt"), row.names = F, quote = F, sep = "\t")


```

```{r}
p1 <- ggplot(ML_eqtl_sig_min, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("top significant (genome-wide cutoff)")
p2 <- ggplot(ML_eqtl_sig_random, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("random significant (genome-wide cutoff)")
p1 + p2 + plot_layout(nrow = 2)

```

```{r}
p12 <- ggplot(ML_eqtl_sig_min, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("top significant (gene-specific cutoff)")
p22 <- ggplot(ML_eqtl_sig_random, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("random significant (gene-specific cutoff)")
p12 + p22 + plot_layout(nrow = 2)

```


```{r}

#ML_eqtl_full <- inner_join(ML_eqtl, ML[,c(1,16:19)], by = "phenotype_id") 
#ML_eqtl_sig <- ML_eqtl_full %>% filter(pval_nominal < pval_nominal_threshold) 

ML_eqtl_sig <- ML_eqtl %>% filter(pval_nominal < 0.0318507) 
ML_eqtl_sig <- ML_eqtl_sig %>% mutate(maf = ifelse(af <= 0.5, af, 1 - af))

# top
ML_eqtl_sig_min <- ML_eqtl_sig %>% group_by(phenotype_id) %>% filter(pval_nominal == min(pval_nominal))
set.seed(12)
ML_eqtl_sig_min <- ML_eqtl_sig_min %>% group_by(phenotype_id) %>% slice_sample(n = 1) 
ML_eqtl_sig_min_af <- ML_eqtl_sig_min %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_min_af$maf <- round(ML_eqtl_sig_min_af$maf, digits = 3)

# random
set.seed(123)
ML_eqtl_sig_random <- ML_eqtl_sig %>% group_by(phenotype_id) %>% slice_sample(n = 1) 
ML_eqtl_sig_random_af <- ML_eqtl_sig_random %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_random_af$maf <- round(ML_eqtl_sig_random_af$maf, digits = 3)

# write.table(nrow(ML_eqtl_sig_min_af), file=paste0("ML_", i, "_min.cnt"), row.names = FALSE, quote = FALSE,col.names = F)
# write.table(nrow(ML_eqtl_sig_random_af), file=paste0("ML_", i, "_random.cnt"), row.names = FALSE, quote = FALSE,col.names = F)

p <- ggplot(ML_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) +
scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 
p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
#write.table(p_data, file = paste0(data, "ML_eqtl_real_min_Dec.txt"), row.names = F, quote = F, sep = "\t")
write.table(p_data, file = paste0(data, "ML_eqtl_real_min_Dec_q01.txt"), row.names = F, quote = F, sep = "\t")

p <- ggplot(ML_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) +
scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 
p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
#write.table(p_data, file = paste0(data, "ML_eqtl_real_random_Dec.txt"), row.names = F, quote = F, sep = "\t")
write.table(p_data, file = paste0(data, "ML_eqtl_real_random_Dec_q01.txt"), row.names = F, quote = F, sep = "\t")
```


# one fake
```{r}
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/ml/"
#ML <- read.table(paste0(data, "ML_50.cis_qtl.txt"), header = T) # 14777, min qval=0.4

ML_A1 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.1.parquet"))
ML_A2 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.2.parquet"))
ML_A3 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.3.parquet"))
ML_A4 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.4.parquet"))
ML_eqtl_50 <- rbind(ML_A1, ML_A2, ML_A3, ML_A4) # 1272993
sum(ML$num_var) # 1272993

#ML_eqtl50_sig01 <- ML_eqtl_50 %>% filter(pval_nominal < 0.001) # 102276 -> 42322
ML_eqtl50_sig01 <- ML_eqtl_50 %>% filter(pval_nominal < 0.0318507)
# old way: 17283
ML_eqtl_sig <- ML_eqtl50_sig01

ML_eqtl_sig <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>%
  mutate(count = n()) %>%  
  ungroup() %>%           
  filter(count <= 10) # 24585


ML_eqtl_full <- inner_join(ML_eqtl_50, ML[,c(1,16:19)], by = "phenotype_id") 
ML_eqtl_sig <- ML_eqtl_full %>% filter(pval_nominal < pval_nominal_threshold)

ML_eqtl_sig <- ML_eqtl_sig %>% mutate(maf = ifelse(af <= 0.5, af, 1 - af))
ML_eqtl_sig_min <- ML_eqtl_sig %>%
    group_by(phenotype_id) %>% 
    filter(pval_nominal == min(pval_nominal))  # 2879 -> 10826, 9215
ML_eqtl_sig_min <- ML_eqtl_sig_min %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1) # 10778, 9165

ML_eqtl_sig_min_af <- ML_eqtl_sig_min %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_min_af$maf <- round(ML_eqtl_sig_min_af$maf, digits = 3)
    
set.seed(123)
ML_eqtl_sig_random <- ML_eqtl_sig %>%
  group_by(phenotype_id) %>% 
  slice_sample(n = 1) # 2868, 10778

ML_eqtl_sig_random_af <- ML_eqtl_sig_random %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_random_af$maf <- round(ML_eqtl_sig_random_af$maf, digits = 3)
  

p<-ggplot(ML_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) + scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 

p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
write.table(p_data, file = paste0(data, "ML_eqtl_fake50_Dec10_genewise.txt"), row.names = F, quote = F, sep = "\t")

p<-ggplot(ML_eqtl_sig_random_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) + scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 

p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
write.table(p_data, file = paste0(data, "ML_eqtl_fake50_random_Dec10_genewise.txt"), row.names = F, quote = F, sep = "\t")

p3 <- ggplot(ML_eqtl_sig_min, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("top significant")
p4 <- ggplot(ML_eqtl_sig_random, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("random significant")
p3 + p4 + plot_layout(nrow = 2)

```

```{r}
p3 <- ggplot(ML_eqtl_sig_min, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("top significant (genome-wide cutoff)")
p4 <- ggplot(ML_eqtl_sig_random, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("random significant (genome-wide cutoff)")
p3 + p4 + plot_layout(nrow = 2)

```

```{r}
p32 <- ggplot(ML_eqtl_sig_min, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("top significant (gene-specific cutoff)")
p42 <- ggplot(ML_eqtl_sig_random, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.0001) + theme_classic() + xlab("p-value")+ggtitle("random significant (gene-specific cutoff)")
p32 + p42 + plot_layout(nrow = 2)

```


```{r}
p2 + p22 + p4 + p42+ plot_layout(nrow = 2)
```


```{r}
p1 + p2 + p3 + p4 + plot_layout(nrow = 2)
```


```{r}
p1 + p2 + p3 + p4 + plot_layout(nrow = 2)

```

test
```{r}


length(unique(ML_eqtl$phenotype_id)) # 14777
ML_eqtl_min <- ML_eqtl %>%
    group_by(phenotype_id) %>% 
    filter(pval_nominal == min(pval_nominal)) # 14840 # ties
length(unique(ML_eqtl_min$phenotype_id)) # 14777

ML_eqtl_min <- ML_eqtl_min %>% dplyr::select(phenotype_id, pval_nominal) %>% distinct() # 14777

qvals <- qvalue(ML_eqtl_min$pval_nominal)$qvalues
ML_eqtl_min$qvalue <- qvals

ML_eqtl_min01 <- ML_eqtl_min[ML_eqtl_min$qvalue < 0.1,] # every gene has qval < 0.1
max(ML_eqtl_min01$pval_nominal) # 0.9963844

```


# plot together
```{r}
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"

# random
maf_real <- read.table(paste0(data, "ML_eqtl_real_random_Dec.txt"), header = T)

#maf_real <- read.table(paste0(data, "ML_eqtl_real_random_nov21.txt"), header = T)
#maf_real <- read.table(paste0(data, "ML_eqtl_real_nov22.txt"), header = T)

maf_real <- maf_real %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))
#ggplot(maf_real, aes(x=x_axis, y=y_prop)) + geom_point() + theme_classic()  + labs(x="MAF", y="Proportion") 


# maf_null <- read.table(paste0(data, "ML_MAF_null_new.txt"), header = T)
# min
maf_null <- read.table(paste0(data, "ML_MAF_null_min.txt"), header = T)
# random
maf_null <- read.table(paste0(data, "ML_MAF_null_random.txt"), header = T)

maf_null <- read.table(paste0(data, "ML_eqtl_fake50_random_nov21.txt"), header = T)
#maf_null <- read.table(paste0(data, "ML_eqtl_fake50_random_nov21.txt"), header = T)
#maf_null <- read.table(paste0(data, "ML_eqtl_fake50_nov22.txt"), header = T)
colnames(maf_null) <- c("x", "xmin","xmax","y", "y_prop")
maf_null <- maf_null %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))

# random
maf_real <- read.table(paste0(data, "ML_eqtl_real_random_Dec_q01.txt"), header = T)
maf_real <- maf_real %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))
maf_null <- read.table(paste0(data, "ML_MAF_null_random_q01.txt"), header = T)
colnames(maf_null) <- c("x", "xmin","xmax","y", "y_prop")
maf_null <- maf_null %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))

p1 <- ggplot(maf_null, aes(x_axis, y_prop)) + 
    geom_point(fill = NA, colour = "lightgrey", alpha = 0.6)+
    geom_point(data = maf_real, color = "black", fill="black", alpha = 0.9)+ 
    theme_classic()+ labs(x="MAF", y="Proportion", title = "random significant")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),text = element_text(size = 10))

# min
maf_real <- read.table(paste0(data, "ML_eqtl_real_min_Dec_q01.txt"), header = T)
maf_real <- maf_real %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))
maf_null <- read.table(paste0(data, "ML_MAF_null_min_q01.txt"), header = T)
colnames(maf_null) <- c("x", "xmin","xmax","y", "y_prop")
maf_null <- maf_null %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))

p2 <- ggplot(maf_null, aes(x_axis, y_prop)) + 
    geom_point(fill = NA, colour = "lightgrey", alpha = 0.6)+
    geom_point(data = maf_real, color = "black", fill="black", alpha = 0.9)+ 
    theme_classic()+ labs(x="MAF", y="Proportion", title = "top significant")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),text = element_text(size = 10))

p1 + p2
```


/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/ML_eqtl_real_random_Dec10.txt
/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/ML_eqtl_fake50_random_Dec10.txt


/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/ML_eqtl_real_random_Dec10_genewise.txt
/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/ML_eqtl_fake50_random_Dec10_genewise.txt
```{r}
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"
# random, genome wide
maf_real <- read.table(paste0(data, "ML_eqtl_real_random_Dec10.txt"), header = T)
maf_real <- maf_real %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))
maf_null <- read.table(paste0(data, "ML_eqtl_fake50_random_Dec10.txt"), header = T)
colnames(maf_null) <- c("x", "xmin","xmax","y", "y_prop")
maf_null <- maf_null %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))

p1 <- ggplot(maf_null, aes(x_axis, y_prop)) + 
    geom_point(fill = NA, colour = "lightgrey", alpha = 1)+
    geom_point(data = maf_real, color = "black", fill="black", alpha = 0.9)+ 
    theme_classic()+ labs(x="MAF", y="Proportion", title = "random significant (genome-wide)")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),text = element_text(size = 10))

# random, gene specifc
maf_real <- read.table(paste0(data, "ML_eqtl_real_random_Dec10_genewise.txt"), header = T)
maf_real <- maf_real %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))
maf_null <- read.table(paste0(data, "ML_eqtl_fake50_random_Dec10_genewise.txt"), header = T)
colnames(maf_null) <- c("x", "xmin","xmax","y", "y_prop")
maf_null <- maf_null %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))

p2 <- ggplot(maf_null, aes(x_axis, y_prop)) + 
    geom_point(fill = NA, colour = "lightgrey", alpha = 1)+
    geom_point(data = maf_real, color = "black", fill="black", alpha = 0.9)+ 
    theme_classic()+ labs(x="MAF", y="Proportion", title = "random significant (gene-specific)")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),text = element_text(size = 10))

p1+p2
```


## filt
/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/ML_MAF_null_random_q01_filt.txt
```{r}
data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/eqtl/"
# random, genome wide
maf_real <- read.table(paste0(data, "ML_eqtl_real_random_Dec10.txt"), header = T)
maf_real <- maf_real %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))
maf_null <- read.table(paste0(data, "ML_MAF_null_random_q01_filt.txt"), header = F)
colnames(maf_null) <- c("x", "xmin","xmax","y", "y_prop")
maf_null <- maf_null %>% mutate(x_axis = paste(xmin, xmax, sep = "-"))

ggplot(maf_null, aes(x_axis, y_prop)) + 
    geom_point(fill = NA, colour = "lightgrey", alpha = 1)+
    geom_point(data = maf_real, color = "black", fill="black", alpha = 0.9)+ 
    theme_classic()+ labs(x="MAF", y="Proportion", title = "random significant (genome-wide)")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),text = element_text(size = 10))
```


## 50 times?
```{r}
library(arrow)
library(dplyr)
library(ggplot2)
setwd("/ohta2/meng.yuan/rumex/eqtl/tensorqtl/ml")
args = commandArgs(trailingOnly=TRUE)
i <- as.numeric(args[1])

#ML <- read.table("ML.cis_qtl.txt", header = T) 
ML_A1 <- read_parquet(paste0("ML_", i, ".cis_qtl_pairs.1.parquet"))
ML_A2 <- read_parquet(paste0("ML_", i, ".cis_qtl_pairs.2.parquet"))
ML_A3 <- read_parquet(paste0("ML_", i, ".cis_qtl_pairs.3.parquet"))
ML_A4 <- read_parquet(paste0("ML_", i, ".cis_qtl_pairs.4.parquet"))
ML_eqtl <- rbind(ML_A1, ML_A2, ML_A3, ML_A4) 

ML_eqtl_sig <- ML_eqtl %>% filter(pval_nominal < 0.0318507) 
ML_eqtl_sig <- ML_eqtl_sig %>% mutate(maf = ifelse(af <= 0.5, af, 1 - af))
ML_eqtl_sig_min <- ML_eqtl_sig %>% group_by(phenotype_id) %>% filter(pval_nominal == min(pval_nominal)) 
ML_eqtl_sig_min_af <- ML_eqtl_sig_min %>% dplyr::select(variant_id, af, maf) %>% distinct()
ML_eqtl_sig_min_af$maf <- round(ML_eqtl_sig_min_af$maf, digits = 3)
write.table(nrow(ML_eqtl_sig_min_af), file=paste0("ML_", i, ".cnt"), row.names = FALSE, quote = FALSE,col.names = F)

p <- ggplot(ML_eqtl_sig_min_af, aes(x=maf)) + geom_histogram(binwidth=0.05, , boundary = 0.05) + scale_x_continuous(limits = c(0.05, 0.5))
p_data <- ggplot_build(p)$data[[1]]
p_data$y_prop <- p_data$y/sum(p_data$y) 
p_data <- p_data %>% select(x, xmin, xmax, y, y_prop)
write.table(p_data, file = paste0("ML_", i, "_eqtl_fake.txt"), row.names = FALSE, quote = FALSE, sep = "\t", col.names = F) 
```



# extra
```{r}
ggplot(ML, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white",binwidth = 0.005) + theme_classic() + xlab("p-value")+ggtitle("pval_nominal")

ggplot(ML, aes(x=pval_perm)) + geom_histogram(color="black", fill="white",binwidth = 0.005) + theme_classic() + xlab("p-value")+ggtitle("pval_perm")

ggplot(ML, aes(x=pval_beta)) + geom_histogram(color="black", fill="white",binwidth = 0.005) + theme_classic() + xlab("p-value")+ggtitle("pval_beta")

```

real
```{r}
ML_A1 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.1.parquet"))
ML_A2 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.2.parquet"))
ML_A3 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.3.parquet"))
ML_A4 <- read_parquet(paste0(data,"ML.cis_qtl_pairs.4.parquet"))
ML_eqtl <- rbind(ML_A1, ML_A2, ML_A3, ML_A4) # 1272993

data <- "/Users/yuanmeng/Library/CloudStorage/OneDrive-UniversityofToronto/Manuscripts/rumex_eqtl/ml/"
ML_A1 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.1.parquet"))
ML_A2 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.2.parquet"))
ML_A3 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.3.parquet"))
ML_A4 <- read_parquet(paste0(data,"ML_50.cis_qtl_pairs.4.parquet"))
ML_eqtl_50 <- rbind(ML_A1, ML_A2, ML_A3, ML_A4) # 1272993

p1 <- ggplot(ML_eqtl, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.005) + theme_classic() + xlab("p-value")+ggtitle("real")
p2 <- ggplot(ML_eqtl_50, aes(x=pval_nominal)) + geom_histogram(color="black", fill="white", binwidth = 0.005) + theme_classic() + xlab("p-value")+ggtitle("1 permutation")
p1 + p2 + plot_layout(nrow = 2)
```

```{r}
ggplot(ML, aes(x=pval_nominal_threshold)) + geom_histogram(color="black", fill="white", binwidth = 0.001) + theme_classic() + xlab("p-value")+ggtitle("pval_nominal_threshold")

```
```{r}
ggplot(ML, aes(x=qval, y=qval2)) + geom_point()+ theme_classic()
```

